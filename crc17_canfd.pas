unit crc17_canfd;
//CRC-17 CAN-FD
//Author: domasz
//Version: 0.1 (2022-11-17)
//Licence: MIT

interface

uses SysUtils, HasherBase;

type THashercrc17_canfd = class(THasherbase)
  private
    FHash: Cardinal;
  public
    constructor Create; override;
    procedure Update(Msg: PByte; Length: Integer); override;
    function Final: String; override;
end;


implementation

var Table: array[0..255] of LongInt = (
$00000000, $0001685B, $0001B8ED, $0000D0B6, $00001981, $000171DA, $0001A16C, $0000C937,
$00003302, $00015B59, $00018BEF, $0000E3B4, $00002A83, $000142D8, $0001926E, $0000FA35,
$00006604, $00010E5F, $0001DEE9, $0000B6B2, $00007F85, $000117DE, $0001C768, $0000AF33,
$00005506, $00013D5D, $0001EDEB, $000085B0, $00004C87, $000124DC, $0001F46A, $00009C31,
$0000CC08, $0001A453, $000174E5, $00001CBE, $0000D589, $0001BDD2, $00016D64, $0000053F,
$0000FF0A, $00019751, $000147E7, $00002FBC, $0000E68B, $00018ED0, $00015E66, $0000363D,
$0000AA0C, $0001C257, $000112E1, $00007ABA, $0000B38D, $0001DBD6, $00010B60, $0000633B,
$0000990E, $0001F155, $000121E3, $000049B8, $0000808F, $0001E8D4, $00013862, $00005039,
$00019810, $0000F04B, $000020FD, $000148A6, $00018191, $0000E9CA, $0000397C, $00015127,
$0001AB12, $0000C349, $000013FF, $00017BA4, $0001B293, $0000DAC8, $00000A7E, $00016225,
$0001FE14, $0000964F, $000046F9, $00012EA2, $0001E795, $00008FCE, $00005F78, $00013723,
$0001CD16, $0000A54D, $000075FB, $00011DA0, $0001D497, $0000BCCC, $00006C7A, $00010421,
$00015418, $00003C43, $0000ECF5, $000184AE, $00014D99, $000025C2, $0000F574, $00019D2F,
$0001671A, $00000F41, $0000DFF7, $0001B7AC, $00017E9B, $000016C0, $0000C676, $0001AE2D,
$0001321C, $00005A47, $00008AF1, $0001E2AA, $00012B9D, $000043C6, $00009370, $0001FB2B,
$0001011E, $00006945, $0000B9F3, $0001D1A8, $0001189F, $000070C4, $0000A072, $0001C829,
$0000587B, $00013020, $0001E096, $000088CD, $000041FA, $000129A1, $0001F917, $0000914C,
$00006B79, $00010322, $0001D394, $0000BBCF, $000072F8, $00011AA3, $0001CA15, $0000A24E,
$00003E7F, $00015624, $00018692, $0000EEC9, $000027FE, $00014FA5, $00019F13, $0000F748,
$00000D7D, $00016526, $0001B590, $0000DDCB, $000014FC, $00017CA7, $0001AC11, $0000C44A,
$00009473, $0001FC28, $00012C9E, $000044C5, $00008DF2, $0001E5A9, $0001351F, $00005D44,
$0000A771, $0001CF2A, $00011F9C, $000077C7, $0000BEF0, $0001D6AB, $0001061D, $00006E46,
$0000F277, $00019A2C, $00014A9A, $000022C1, $0000EBF6, $000183AD, $0001531B, $00003B40,
$0000C175, $0001A92E, $00017998, $000011C3, $0000D8F4, $0001B0AF, $00016019, $00000842,
$0001C06B, $0000A830, $00007886, $000110DD, $0001D9EA, $0000B1B1, $00006107, $0001095C,
$0001F369, $00009B32, $00004B84, $000123DF, $0001EAE8, $000082B3, $00005205, $00013A5E,
$0001A66F, $0000CE34, $00001E82, $000176D9, $0001BFEE, $0000D7B5, $00000703, $00016F58,
$0001956D, $0000FD36, $00002D80, $000145DB, $00018CEC, $0000E4B7, $00003401, $00015C5A,
$00010C63, $00006438, $0000B48E, $0001DCD5, $000115E2, $00007DB9, $0000AD0F, $0001C554,
$00013F61, $0000573A, $0000878C, $0001EFD7, $000126E0, $00004EBB, $00009E0D, $0001F656,
$00016A67, $0000023C, $0000D28A, $0001BAD1, $000173E6, $00001BBD, $0000CB0B, $0001A350,
$00015965, $0000313E, $0000E188, $000189D3, $000140E4, $000028BF, $0000F809, $00019052
);

constructor THashercrc17_canfd.Create;
begin
  inherited Create;
  FHash := 0;
  Check := '04F03';
end;

procedure THashercrc17_canfd.Update(Msg: PByte; Length: Integer);
var i: Integer;
begin
  for i:=0 to Length-1 do begin
    FHash := (FHash shl 8) xor Table[(Msg^ xor (FHash shr 9)) and $FF];
    Inc(Msg);
  end;   
end;

function THashercrc17_canfd.Final: String;
begin
  FHash := FHash and $1FFFF;

  Result := IntToHex(FHash, 5);
end;


initialization
  HasherList.RegisterHasher('CRC-17 CAN-FD', THashercrc17_canfd);

end.
